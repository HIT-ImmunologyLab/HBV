#Data analysis for Spatial Transcriptome data (edit by ccg)
# 1:Analysis for fastq file
spaceranger count --id="IT-A-A2" \
                  --description="IT-A-A2" \
                  --transcriptome=path to genome reference file/refdata-gex-GRCh38-2020-A \
                  --fastqs=path to fastq file/IT-A-A2 \
                  --image=path to image file/D.vmic.15139.tif \
                  --slide=V11Y10-019-D1 \
                  --area=C1 \
                  --localcores=60 \
                  --localmem=500

#2:Annotation for Spatial Transcriptome data
library(SeuratData)
library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
library(Cairo)

#import count files generated by 'spaceranger count'
setwd('path to count files')
IT <- Seurat::Load10X_Spatial(data.dir = "./IT/outs",slice='IT')
IT$orig.ident <- 'IT'
Idents(IT) <- IT$orig.ident
IC <- Seurat::Load10X_Spatial(data.dir = "./IC/outs",slice='IC')
IC$orig.ident <- 'IC'
Idents(IC) <- IC$orig.ident
AHB <- Seurat::Load10X_Spatial(data.dir = "./AHB/outs",slice='AHB')
AHB$orig.ident <- 'AHB'
Idents(AHB) <- AHB$orig.ident
IA <- Seurat::Load10X_Spatial(data.dir = "./IA/outs",slice='IA')
IA$orig.ident <- 'IA'
Idents(IA) <- IA$orig.ident

#normalization
IT <- SCTransform(IT, assay = "Spatial", verbose = FALSE) %>% RunPCA(verbose = FALSE)
IC <- SCTransform(IC, assay = "Spatial", verbose = FALSE) %>% RunPCA(verbose = FALSE)
AHB<- subset(AHB, subset = nCount_Spatial > 0)
AHB <- SCTransform(AHB, assay = "Spatial", verbose = FALSE) %>% RunPCA(verbose = FALSE)
IA<- subset(IA, subset = nCount_Spatial > 0)
IA <- SCTransform(IA, assay = "Spatial", verbose = FALSE) %>% RunPCA(verbose = FALSE)
hbv_spatial_list <- list('AHB'=AHB,'IA'=IA,'IC'=IC,'IT'=IT)

#load reference scRNA-seq data
liver_all_filter <- readRDS('path to reference scRNA-seq data/liver_all_filter.rds')

#cell type annotation
set.seed(123)
liver_all_filter_ref <- liver_all_filter
Idents(liver_all_filter_ref) <- liver_all_filter_ref$celltype_final2
liver_all_filter_ref <- SCTransform(liver_all_filter_ref, ncells = 5000, verbose = FALSE) %>% RunPCA(verbose = FALSE) %>% RunUMAP(dims = 1:50)

predictions <- list()
predictions_rename <- list()
cell_num_path <- '/newdata/Single_cell_multi_omics_analysis/spatial_transcriptome/analysis_2022_10_10/cluster_annotation/celltype_plot_gzmb/'
for(i in 1:length(hbv_spatial_list)){
	DefaultAssay(hbv_spatial_list[[i]]) <- "SCT"
	anchors <- FindTransferAnchors(reference = liver_all_filter_ref, query = hbv_spatial_list[[i]], normalization.method = "SCT",dims=1:50)
	#predictions_assay <- TransferData(anchorset = anchors, refdata = liver_all_filter_ref$celltype_final, prediction.assay = TRUE, weight.reduction = AHB[["pca"]],dims=1:30)
	predictions[[i]] <- TransferData(anchorset = anchors, refdata = liver_all_filter_ref$celltype_final2, prediction.assay = FALSE,weight.reduction = hbv_spatial_list[[i]][["pca"]], dims = 1:50)
	predic_mtrx <- as.data.frame(predictions[[i]])
	hbv_spatial_list[[i]]$seurat_celltype_all_new_2 <- predic_mtrx$predicted.id
	
	predictions_rename[[i]] <- predictions[[i]]
	predictions_rename[[i]] <- predictions_rename[[i]][,-c(1,dim(predictions[[i]])[2])]
	colnames(predictions_rename[[i]]) <- gsub('prediction.score.','',colnames(predictions_rename[[i]]))
	colnames(predictions_rename[[i]]) <- gsub('\\.',' ',colnames(predictions_rename[[i]]))
	seurat_second_celltype <- apply(predictions_rename[[i]], 1, function(t) colnames(predictions_rename[[i]])[order(t,decreasing=TRUE)[2]])
	hbv_spatial_list[[i]]$seurat_celltype_all_new_2_wei2 <- seurat_second_celltype
	seurat_third_celltype <- apply(predictions_rename[[i]], 1, function(t) colnames(predictions_rename[[i]])[order(t,decreasing=TRUE)[3]])
	hbv_spatial_list[[i]]$seurat_celltype_all_new_2_wei3 <- seurat_third_celltype
}


